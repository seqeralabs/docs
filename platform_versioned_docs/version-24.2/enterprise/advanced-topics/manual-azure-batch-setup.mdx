---
title: Azure Batch compute environment setup
headline: "Azure Batch compute environment tutorial"
description: "A tutorial for using Azure Batch with Seqera Platform"
---

This guide details how to set up an Azure Batch and Seqera Cloud account to run a workflow in a Seqera Azure Batch compute environment.

It begins with the simplest possible setup and then details more complex environment configuration options. 

## Prerequisites

- An Azure account with sufficient permissions to create resources.
- [Azure CLI][install-azure-cli]
- [Seqera Platform CLI][install-seqera-cli]

### Set up Azure Batch

In the Azure Portal:

1. Create an Azure Storage account with the default settings.
1. In the Azure Storage account, add a single blob container called `work`. This is the [Nextflow working directory][nextflow-working-directory].
1. Create a new Azure Batch account. Use Batch Managed for now, with the default settings. Use the same region as your Storage account and attach the Storage account to the Batch account when prompted.
1. On the Azure Batch page, select **Quotas**.
1. Select **Request Quota Increase**.
1. For **Quota Type**, select **Batch**, then select **Next**.
1. Select **Enter Details**, then choose the **Location** as the region of your Batch account.
1. Select **EDv5 Series**.
1. Select **Spot/low-priority vCPUS (all Series)**.
1. Select **Active jobs and job schedules per Batch account**.
1. Select **Pools per Batch account**.

Increase each value to a minimum of the following:

- **EDv5 Series**: 192
- **Active jobs and job schedules per Batch account**: 100
- **Pools per Batch account**: 50
- **Spot/low-priority vCPUS (all Series)**: 192

### Set up Seqera Cloud

In Seqera Cloud:

- Create a new account.
- [Create a new organization and workspace][create-org-workspace].
- Add a GitHub credential the workspace to prevent API rate-limiting issues with GitHub.

## Compute environment configuration

### 1. Azure Batch with Seqera Batch Forge

First, add the Azure Batch account credentials to Seqera Platform:

1. In the Azure portal, go to the Batch account you created and note the Batch account name and region.
1. Go to the **Keys** tab to find the primary access keys for the Batch account and Storage account.
1. In your Seqera Platform workspace, go to the **Credentials** tab and select **Add credentials**.
1. Enter a credential name such as `azure-keys` and select Azure from the **Provider** dropdown.
1. Enter the Batch account name and key, and Storage account name and key.
1. Select **Create** to save the credentials.

Seqera Platform now has the credentials it needs to access your Azure Batch and Storage accounts and make the necessary changes.

Next, create a compute environment with Batch Forge:

1. Go to the **Compute Environments** tab and select **Add Compute Environment**.
1. Enter a name such as `1-azure-batch-forge`.
1. Select Azure Batch from the **Provider** dropdown.
1. Sellect your `azure-keys` credentials.
1. Select the **Region** of your Batch account.
1. Select the `az://work` container in your Storage account.
1. For **VMs type**, select `standard_e2ds_v5`.
1. For **VMs count**, select 4.
1. Enable **Autoscale** and **Dispose resources**.
1. All other options can be left default. Select **Create** to save the compute environment.

Add the `nextflow-hello` pipeline to your workspace:

[Add a pipeline][add-pipeline] from your workspace Launchpad with the following settings:

- Select your Azure Batch compute environment from the dropdown. 
- For **Pipeline to launch**, enter `https://github.com/nextflow-io/hello`. 
- For **Work directory**, enter a subdirectory in the `az://work` container in your Storage account.

Select **Launch** next to the pipeline name in your workspace Launchpad to complete the launch form and launch the workflow. 

Behavior:

- Seqera Platform will submit a Nextflow job and task to this pool.
- The Nextflow job will execute and submit each task to the same node pool on Azure Batch.
- The node pool will autoscale up and down based on the number of waiting tasks.

Advantages:

- Simple to set up.
- Low cost.
- Autoscales for number of waiting tasks.

Disadvantages:

- The Nextflow job will submit each task to the same node pool on Azure Batch, which can cause bottlenecks.
- Because the processes require larger resources than the head node, you often have oversized machines running Nextflow or undersized machines running processes.
- Dedicated nodes only.

### 2. Use a separate node and head pool on Seqera Platform

Create a separate node pool to run all the processes:

1. Create another compute environment in Seqera Platform, exactly as before:
    - **Name**: `2-azure-batch-low-priority` or similar
    - **Platform**: Azure Batch
    - **Credentials**: `azure-keys`
    - **Region**: As before
    - **Pipeline work directory**: As before
    - **VMs type**: `standard_e2ds_v5`
    - **VMs count**: `4`
1. Note the compute environment ID, which is the first item on the compute environment page.
1. In the Azure Portal, go to the Batch account you created earlier.
1. Go to the **Pools** tab and create a new pool.
1. Find the pool called `tower-pool-${id}`, where `${id}` is the ID you noted earlier.
1. Select **Scale**.
1. An Autoscale formula is displayed. On the second-to-last line, there will be a line that starts with `$TargetDedicatedNodes`. Change this string to `$TargetLowPriorityNodes`.
1. Select **Evaluate**, then **Save**.

You have created a new node pool that uses low-priority VMs, which are cheaper than dedicated VMs. You can now run Nextflow on the first pool, but execute all the processes on the second pool.

1. On the pipeline launch page, duplicate the existing pipeline, but do not save it yet.
1. Under advanced options, add the following configuration block to the `nextflow.config` text input:

    ```nextflow
    process.queue = 'tower-pool-${id}'
    ```

    :::info
    Remember to replace `${id}` with the ID of the compute environment you created earlier!
    :::

1. Save the pipeline as `hello-world-low-priority`.

Select **Launch** next to the pipeline name in your workspace Launchpad to complete the launch form and launch the workflow. 

Behavior:

- Seqera Platform will submit a Nextflow job and task to the first pool, which uses dedicated VMs.
- The Nextflow job will execute and submit each task to the second pool, which uses low-priority VMs.
- Both pools will autoscale up and down based on the number of waiting tasks.

Advantages:

- The processes are not bottlenecked by the head node.
- You can set the worker nodes to use a different VM size than the head node.
- Cheaper nodes for work.

Disadvantages:

- More complex to set up.
- Still fairly inflexible.
- You have to wait a long time for nodes to autoscale up and down in response to the work.

### 3. Configure the head pool to have a "hot" node

Next, leave a single head node up and running to make the response time faster:

1. Get the ID of the first node pool (`1-azure-batch-forge`).
1. On the Azure Portal, go to the Batch account you created earlier.
1. Go to the "Pools" tab and find the pool called `tower-pool-${id}`, where `${id}` is the ID you made a note of earlier.
1. Click "Scale"
1. For the line `targetPoolSize = max(0, min($targetVMs, 4));`, change the `0` to `1`.
1. Click "Evaluate", then "Save"

The node pool will increase to a minimum of 1 node. Now, when we make adjustments to the pipeline, we will see that the head node is not scaled down.

Launch the hello-world-low-priority again and although it will be hard to tell, it will respond much faster. The _latency_ of the pipeline has gone done, although overall time will be similar.

Behavior:

- The head node will stay up and running.
- The worker node pool will autoscale up and down based on the number of tasks waiting.

Advantages:

- The latency of the pipeline has gone down.

Disadvantages:

- We are paying for a head node that is always up.

> [!NOTE]
> If you do not wish to continue paying for the head node, you can scale the node pool back down to by replacing the original autoscale formula.
> You can also delete the compute environment from Seqera Platform, which will delete the head node.

### 4. Use the Nextflow autopool feature

The autopool feature allows Nextflow to automatically create and manage Azure Batch pools based on your pipeline's requirements.

1. Duplicate the `hello-world-low-priority` pipeline to a new pipeline called `hello-world-autopool`.
1. Update your Nextflow config to use autopool mode:

```nextflow
process.queue = "auto"
process.machineType = "Standard_E*d_v5"
azure {
    batch {
        autoPoolMode = true
        allowPoolCreation = true
        pools {
            auto {
                autoscale = true
                vmCount = 1
                maxVmCount = 4
            }
        }
    }
}
```

3. Save the pipeline

As before, click "Launch" to run the pipeline.

Behavior:

- Seqera Platform will submit a Nextflow job and task to the first pool, which uses dedicated VMs.
- The Nextflow job will create pools in the Azure Batch account based on the pipeline's requirements.
- The pools will be called `nf-pool-${id}`, where `${id}` is a unique identifier for the pool.
- The pools will be created with the VM size specified in the Nextflow config.
- The pools will be created with the autoscale settings specified in the Nextflow config.

> [!NOTE]
> Nextflow will create a range of pools based on resource sizes and try to reuse them for similar tasks.
> This means that if you run a process with different CPU, memory or machineType, it will create a new pool for that process.

Advantages:

- We can let Nextflow handle the creation and management of pools.
- We can create flexible pools with the correct VM size and autoscale settings.

Disadvantages:

- We can be overly specific with our pools and end up with a lot of pools, which can exhaust our quota of maximum number of pools.
- We are not using low-priority nodes again!

### 5. Use Nextflow autopool feature with low-priority nodes

1. Duplicate the `hello-world-autopool` pipeline to a new pipeline called `hello-world-autopool-low-priority`.
1. Update your Nextflow config to use low-priority nodes:

```nextflow
process.queue = "auto"
process.machineType = "Standard_E*d_v5"
azure {
    batch {
        autoPoolMode = true
        allowPoolCreation = true
        pools {
            auto {
                autoscale = true
                vmCount = 1
                maxVmCount = 4
            }
        }
    }
}
```

3. Save the pipeline

Launch the pipeline by clicking "Launch".

Behavior:

- Seqera Platform will submit a Nextflow job and task to the first pool, which uses dedicated VMs.
- The Nextflow job will create pools in the Azure Batch account based on the pipeline's requirements.
- The pools will be called `nf-pool-${id}`, where `${id}` is a unique identifier for the pool.
- The pools will be created with the VM size specified in the Nextflow config.
- The pools will be created with the autoscale settings specified in the Nextflow config.
- These pools will use low-priority nodes. It achieves this by modifying the autoscale formula.

Advantages:

- We can let Nextflow handle the creation and management of pools.
- We can create flexible pools with the correct VM size and autoscale settings.
- We are using low-priority nodes.

Disadvantages:

- Spot and low-priority nodes can be preempted, which can cause the pipeline to fail.

### 6. Use Entra authentication

Docs: https://www.nextflow.io/docs/latest/azure.html#microsoft-entra

#### Create service principal for the platform to authenticate as
1. Create service principal in Azure (https://learn.microsoft.com/en-us/entra/identity-platform/howto-create-service-principal-portal)
1. Assign roles to the service principal (https://learn.microsoft.com/en-us/azure/role-based-access-control/role-assignments-portal?tabs=current)
1. Get Service Principal ID, Tenant ID and Client Secret (https://learn.microsoft.com/en-us/entra/identity-platform/howto-create-service-principal-portal#option-3-create-a-new-client-secret)
1. Add to Seqera Platform credentials (https://docs.seqera.io/platform/24.2/compute-envs/azure-batch#entra-service-principal)

On Seqera Platform:

1. Add new credentials with the name `entra-keys` and select the type "Azure"
1. Add the Service Principal ID, Tenant ID and Client Secret
1. Click "Create" to save the credentials

#### Create a managed identity for Nextflow to authenticate as

Back on the Azure Portal:

1. Create a managed identity https://learn.microsoft.com/en-us/entra/identity/managed-identities-azure-resources/how-manage-user-assigned-managed-identities?pivots=identity-mi-methods-azp
1. Assign the relevant roles to the managed identity (https://learn.microsoft.com/en-us/azure/role-based-access-control/role-assignments-portal?tabs=current and https://www.nextflow.io/docs/latest/azure.html#required-role-assignments)
1. Note the managed identity client ID for later
1. Go to the Azure Portal, go to the Batch account you created earlier.
1. Go to the "Pools" tab and find the pool called `tower-pool-${id}`, where `${id}` is the ID of the head node pool you made earlier
1. Click "Identity"
1. Click "Add User Assigned Identity"
1. Select the managed identity you created earlier
1. Click "Add"

Processes running on this pool will can now use the managed identity to authenticate to Azure Batch and Storage.

On Seqera Platform:

1. Add a new compute environment with the name `entra-mi` and select the type `Azure Batch`
1. Select the location as the same region as your Batch account
1. Select the "Config mode" as "Manual"
1. Select the Compute pool name as the pool you added the managed identity to earlier, `tower-pool-${id}`
1. For "Managed Identity Client ID", put the client ID of the managed identity you created earlier

Duplicate the `hello-world-autopool-low-priority` pipeline and save it as `hello-world-entra-mi`.

Launch the pipeline by clicking "Launch".

The pipeline will run as before, but using the managed identity to authenticate to Azure Batch and Storage. No keys or storage required.

> [!NOTE]
> If we wished, we could use User Subscription mode instead of Batch Managed here although this is out of the scope of this tutorial.

Behavior:
- Seqera Platform will authenticate to Azure Batch and Azure Storage using a service principal
- It will submit a job and task to the Azure Batch service using the service principal
- The task will run Nextflow, which will authenticate to Azure Batch and Azure Storage using the managed identity
- All processes will run on the head node like the first example.

Advantages:

- No keys or short access tokens are exchanged, increasing security.
- A service prinicipal can have very granular permissions, so we can grant it only the permissions it needs.
- Managed identities can be scoped to a specific resource, so the Nextflow head job will have very restricted permissions.
- Different managed IDs can have different permissions, meaning different compute environments can have different scoped permissions.

Disadvantages:

- The set up is quite complicated and things can go wrong.
- An error can be harder to diagnose.

### 7. Use a node pool attached to a vnet

It is common to attach Azure Batch pools to a virtual network. This is useful if you want to connect to connect to other resources in the same VNet or place things behind enhanced security. Seqera Platform does not support this feature out of the box, so we must manually create an Azure Batch pool.

Follow the instructions here to create an Azure Batch pool manually that is compatible with Seqera and Nextflow: [TODO: DOCS LINK]. Use the following settings:

- Name & ID: `3-azure-batch-vnet`
- Add the managed identity created earlier as a user-assigned managed identity
- VMs type: `standard_e2ds_v5`
- Use the autoscale formula described in the documentation, with a minimum size of 0 maximum size of 4
- For Virtual network, create a new virtual network with the default subnet. You can add this to a new resource group here.

In practice, we are more likely to connect an Azure Batch Node pool to an existing virtual network that is connected to other resources, such as Seqera Platform or the Azure Storage Acccount. In this instance, connecting it to a vnet with public internet access will route the network traffic via the virtual network while still allowing us to perform every action.

Back on Seqera Platform, add a new compute environment in Azure Batch.

1. Add a new compute environment with the name `3-azure-batch-vnet` and select the type `Azure Batch`
1. Select the location as the same region as your Batch account
1. Select the service principal credentials
1. Select the "Config mode" as "Manual"
1. Select the Compute pool name `3-azure-batch-vnet`
1. Add the ID of the managed identity to the managed identity.

Duplicate the **original** `hellow-world` pipeline and save it as `hello-world-vnet`.

Launch the pipeline by clicking "Launch".

The pipeline will run as before, but it will run on the node pool attached to the vnet. From our perspective, it will look like a normal Azure Batch pipeline run.

Using this technique is how we can run pipelines on Azure Batch with more restrictive networking and security requirements.

Behavior:
- Each worker node will be attached to the vnet and use the security and networking rules of that virtual network subnetwork.
- All other behaviour will be as normal

Advantages:

- Security can be increased by restricting the virtual network subnet.
- Exchange of data can be faster and cheaper than other services.

Disadvantages:

- It requires fairly fiddly setup.
- If security is too restrictive, it can fail silently and be unable to report the error state.

### 8. Use a node pool attached to a vnet with worker nodes attached to the same vnet

Finally, we can combine some of our approaches. We have seen that Nextflow can create and modify Azure Batch pools based on the pipeline requirements. We can also attach Azure Batch pools to a vnet. What if we attach the worker nodes to the same vnet?

To achieve this just requires combinging our approaches above. We will:

- Launch the pipeline on the node pool attached to the vnet
- Use the managed identity to authenticate to Azure Batch and Storage
- The managed identity has permissions to create resources attached to the vnet
- Nextflow will create a node pools attached to the vnet

Let's follow the following steps:

1. Duplicate the `hello-world-entra-mi` pipeline, but modfiy the compute environment to `3-azure-batch-vnet` and change the name to `hello-world-vnet`.
1. Check the virtual network string under the pool details in the Azure Portal, under the Network Configuration section. The value will be Subnet ID, e.g. `/subscriptions/${subscriptionId}/resourceGroups/${resourceGroup}/providers/Microsoft.Network/virtualNetworks/${vnetName}/subnets/${subnetName}`. Save this value.
1. Change the Nextflow configuration under the advnaced tab to include a virtual network with the autopools.

```nextflow
process.queue = "auto"
process.machineType = "Standard_E*d_v5"
azure {
    batch {
        autoPoolMode = true
        allowPoolCreation = true
        pools {
            auto {
                autoscale = true
                vmCount = 1
                maxVmCount = 4
                virtualNetwork = '/subscriptions/${subscriptionId}/resourceGroups/${resourceGroup}/providers/Microsoft.Network/virtualNetworks/${vnetName}/subnets/${subnetName}'
            }
        }
    }
}
```

Launch the pipeline by clicking "Launch".

The pipeline will run as before, but using the managed identity to authenticate to Azure Batch and Storage. Furthermore, it will create worker pools attached to the vnet.

Behavior:
- The same as the previous example, but with additional worker node pools attached to the vnet.

Advantages:

- The same as the previous example
- With the additional flexibility of different node sizes per task requirements.

Disadvantages:

- The same as before
- In addition, we have increased complexity which can introduce errors.

### 9. Clear up resources

Once you have finished, you can delete the pipelines and compute environments from Seqera Platform.

On Azure, you can delete the Batch account, which will delete all pools, jobs and tasks. You can then delete the storage account.

If you wish to keep the Azure resources, you can remove each pool within a batch account and mark any active jobs as terminated.

## Conclusion

This walkthrough has shown how to set up and configure Azure Batch and Seqera Platform to run workflows.

We started by deploying a simple node pool of one type. After that, we pointed the worker processes at different 

[install-azure-cli]: https://learn.microsoft.com/en-us/cli/azure/install-azure-cli
[install-seqera-cli]: ../../cli/installation.mdx
[nextflow-working-directory]: https://www.nextflow.io/docs/latest/cache-and-resume.html#work-directory
[create-org-workspace]: ../../getting-started/workspace-setup.mdx
[add-pipeline]: ../../getting-started/quickstart-demo/add-pipelines.mdx#add-from-the-launchpad