name: Documentation Review

on:
  pull_request:
    paths:
      - 'platform-enterprise_docs/**/*.md'
      - 'platform-enterprise_docs/**/*.mdx'
      - 'platform-cloud/docs/**/*.md'
      - 'platform-cloud/docs/**/*.mdx'
      - 'platform-enterprise_versioned_docs/**/*.md'
      - 'platform-enterprise_versioned_docs/**/*.mdx'
    types: [opened, synchronize, reopened]

  # Manual trigger for full review
  workflow_dispatch:
    inputs:
      review_type:
        description: 'Review type'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - voice-tone
          - terminology
          - clarity

permissions:
  contents: read
  pull-requests: write
  id-token: write

jobs:
  # Get list of changed files
  changes:
    runs-on: ubuntu-latest
    outputs:
      docs: ${{ steps.filter.outputs.docs }}
      docs_files: ${{ steps.filter.outputs.docs_files }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          list-files: json
          filters: |
            docs:
              - 'platform-enterprise_docs/**/*.md'
              - 'platform-enterprise_docs/**/*.mdx'
              - 'platform-cloud/docs/**/*.md'
              - 'platform-cloud/docs/**/*.mdx'
              - 'platform-enterprise_versioned_docs/**/*.md'
              - 'platform-enterprise_versioned_docs/**/*.mdx'

  # Voice and Tone Review
  voice-tone-review:
    needs: changes
    if: needs.changes.outputs.docs == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Voice/Tone Review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ENG_ANTHROPIC_API_KEY }}
          prompt: |
            Use the voice-tone agent to review these changed documentation files:
            ${{ needs.changes.outputs.docs_files }}

            For each issue found, output in this EXACT format:

            FILE: path/to/file.md
            LINE: 42
            ISSUE: Brief description (e.g., "Passive voice", "Third person usage")
            ORIGINAL: |
            exact original text
            SUGGESTION: |
            corrected text
            ---

            Check for:
            - Second person usage (you vs the user)
            - Active vs passive voice
            - Present vs future tense
            - Hedging language

            Write all suggestions to /tmp/voice-tone-suggestions.txt
          use_sticky_comment: true
          claude_args: |
            --allowedTools "Read,Grep,Glob,Write,Task(voice-tone)"

      - name: Post Voice/Tone Suggestions
        run: |
          chmod +x .github/scripts/post-inline-suggestions.sh
          if [[ -f /tmp/voice-tone-suggestions.txt ]]; then
            .github/scripts/post-inline-suggestions.sh /tmp/voice-tone-suggestions.txt ${{ github.event.pull_request.number }}
          else
            echo "‚úÖ No voice/tone issues found"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Terminology Review
  terminology-review:
    needs: changes
    if: needs.changes.outputs.docs == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Terminology Review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ENG_ANTHROPIC_API_KEY }}
          prompt: |
            Use the terminology agent to review these changed documentation files:
            ${{ needs.changes.outputs.docs_files }}

            For each issue found, output in this EXACT format:

            FILE: path/to/file.md
            LINE: 42
            ISSUE: Brief description (e.g., "Use 'Seqera Platform' not 'Tower'")
            ORIGINAL: |
            exact original text
            SUGGESTION: |
            corrected text
            ---

            Check for:
            - Product name consistency (Seqera Platform, Nextflow, etc.)
            - Feature name consistency (Studios capitalized)
            - Formatting conventions (bold for UI, backticks for code)
            - RNA-Seq capitalization rules

            Write all suggestions to /tmp/terminology-suggestions.txt
          use_sticky_comment: true
          claude_args: |
            --allowedTools "Read,Grep,Glob,Write,Task(terminology)"

      - name: Post Terminology Suggestions
        run: |
          chmod +x .github/scripts/post-inline-suggestions.sh
          if [[ -f /tmp/terminology-suggestions.txt ]]; then
            .github/scripts/post-inline-suggestions.sh /tmp/terminology-suggestions.txt ${{ github.event.pull_request.number }}
          else
            echo "‚úÖ No terminology issues found"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Clarity Review
  clarity-review:
    needs: changes
    if: false  # Disabled for now - can be re-enabled later
    # if: needs.changes.outputs.docs == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Clarity Review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ENG_ANTHROPIC_API_KEY }}
          prompt: |
            Use the clarity agent to review these changed documentation files:
            ${{ needs.changes.outputs.docs_files }}

            For each issue found, output in this EXACT format:

            FILE: path/to/file.md
            LINE: 42
            ISSUE: Brief description (e.g., "Sentence too long (45 words)", "Undefined jargon")
            ORIGINAL: |
            exact original text
            SUGGESTION: |
            corrected text
            ---

            Check for:
            - Sentence length (flag over 30 words)
            - Undefined jargon
            - Complex constructions
            - Missing prerequisites

            Write all suggestions to /tmp/clarity-suggestions.txt
          use_sticky_comment: true
          claude_args: |
            --allowedTools "Read,Grep,Glob,Write,Task(clarity)"

      - name: Post Clarity Suggestions
        run: |
          chmod +x .github/scripts/post-inline-suggestions.sh
          if [[ -f /tmp/clarity-suggestions.txt ]]; then
            .github/scripts/post-inline-suggestions.sh /tmp/clarity-suggestions.txt ${{ github.event.pull_request.number }}
          else
            echo "‚úÖ No clarity issues found"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Summary Report
  summary:
    needs: [voice-tone-review, terminology-review]
    # Removed clarity-review from dependencies since it's currently disabled
    if: always() && needs.changes.outputs.docs == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Post Summary
        uses: actions/github-script@v7
        with:
          script: |
            const jobs = [
              { name: 'Voice/Tone', status: '${{ needs.voice-tone-review.result }}' },
              { name: 'Terminology', status: '${{ needs.terminology-review.result }}' }
              // Clarity review temporarily disabled
            ];

            const statusEmoji = {
              'success': '‚úÖ',
              'failure': '‚ùå',
              'skipped': '‚è≠Ô∏è',
              'cancelled': 'üö´'
            };

            let summary = '## üìù Documentation Review Summary\n\n';
            summary += '| Check | Status |\n|-------|--------|\n';

            for (const job of jobs) {
              const emoji = statusEmoji[job.status] || '‚ùì';
              summary += `| ${job.name} | ${emoji} ${job.status} |\n`;
            }

            summary += '\n---\n';
            summary += '*Review powered by Claude Code editorial agents*\n';
            summary += '\n**To apply suggestions:**\n';
            summary += '- Click "Commit suggestion" on individual inline comments\n';
            summary += '- Select multiple suggestions and batch commit them together';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: summary
            });

  # Auto-fix workflow (triggered by /fix-docs comment)
  auto-fix:
    # DISABLED: Auto-fix not needed with inline suggestions
    # Users can apply suggestions individually or batch-commit multiple
    # To re-enable: remove the "if: false" condition below
    if: false
    # if: github.event_name == 'issue_comment' && contains(github.event.comment.body, '/fix-docs')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref }}

      - name: Apply Fixes
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ENG_ANTHROPIC_API_KEY }}
          prompt: |
            Use the docs-fix agent to apply fixes to all changed documentation files in this PR.

            Apply fixes for:
            - Terminology standardization
            - Voice and tone consistency
            - Formatting corrections
            - Inclusive language updates

            Do NOT change code blocks or alter technical meaning.
          claude_args: |
            --allowedTools "Read,Write,Edit,Grep,Glob,Task(docs-fix)"

      - name: Commit Fixes
        run: |
          git config user.name "Claude Code Bot"
          git config user.email "claude-bot@seqera.io"
          git add -A
          git diff --staged --quiet || git commit -m "docs: apply automated style fixes"
          git push
