name: Documentation Review

on:
  pull_request:
    paths:
      - 'platform-enterprise_docs/**/*.md'
      - 'platform-enterprise_docs/**/*.mdx'
      - 'platform-cloud/docs/**/*.md'
      - 'platform-cloud/docs/**/*.mdx'
      - 'platform-enterprise_versioned_docs/**/*.md'
      - 'platform-enterprise_versioned_docs/**/*.mdx'
    types: [opened, synchronize, reopened]

  # Manual trigger for full review
  workflow_dispatch:
    inputs:
      review_type:
        description: 'Review type'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - voice-tone
          - terminology
          - clarity

permissions:
  contents: read
  pull-requests: write
  id-token: write

jobs:
  # Get list of changed files
  changes:
    runs-on: ubuntu-latest
    outputs:
      docs: ${{ steps.filter.outputs.docs }}
      docs_files: ${{ steps.filter.outputs.docs_files }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          list-files: json
          filters: |
            docs:
              - 'platform-enterprise_docs/**/*.md'
              - 'platform-enterprise_docs/**/*.mdx'
              - 'platform-cloud/docs/**/*.md'
              - 'platform-cloud/docs/**/*.mdx'
              - 'platform-enterprise_versioned_docs/**/*.md'
              - 'platform-enterprise_versioned_docs/**/*.mdx'

  # Voice and Tone Review
  voice-tone-review:
    needs: changes
    if: needs.changes.outputs.docs == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Voice/Tone Review
        id: review
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ENG_ANTHROPIC_API_KEY }}
          direct_prompt: |
            Use the voice-tone agent to review these changed documentation files:
            ${{ needs.changes.outputs.docs_files }}

            Check for:
            - Second person usage (you vs the user)
            - Active vs passive voice
            - Present vs future tense
            - Hedging language

            Provide detailed inline comments and a summary in markdown format.
          allowed_tools: "read,grep,glob"

      - name: Post Review Comment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const output = `${{ steps.review.outputs.response }}`;
            if (output && output.trim()) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `## üé≠ Voice & Tone Review\n\n${output}`
              });
            }

  # Terminology Review
  terminology-review:
    needs: changes
    if: needs.changes.outputs.docs == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Terminology Review
        id: review
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ENG_ANTHROPIC_API_KEY }}
          direct_prompt: |
            Use the terminology agent to review these changed documentation files:
            ${{ needs.changes.outputs.docs_files }}

            Check for:
            - Product name consistency (Seqera Platform, Nextflow, etc.)
            - Feature name consistency
            - Formatting conventions (bold for UI, backticks for code)
            - Abbreviation handling

            Provide detailed inline comments and a summary in markdown format.
          allowed_tools: "read,grep,glob"

      - name: Post Review Comment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const output = `${{ steps.review.outputs.response }}`;
            if (output && output.trim()) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `## üìö Terminology Review\n\n${output}`
              });
            }

  # Clarity Review
  clarity-review:
    needs: changes
    if: needs.changes.outputs.docs == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Clarity Review
        id: review
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ENG_ANTHROPIC_API_KEY }}
          direct_prompt: |
            Use the clarity agent to review these changed documentation files:
            ${{ needs.changes.outputs.docs_files }}

            Check for:
            - Sentence length (flag over 30 words)
            - Undefined jargon
            - Complex constructions
            - Missing prerequisites

            Provide detailed inline comments and a summary in markdown format.
          allowed_tools: "read,grep,glob"

      - name: Post Review Comment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const output = `${{ steps.review.outputs.response }}`;
            if (output && output.trim()) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `## üîç Clarity Review\n\n${output}`
              });
            }

  # Summary Report
  summary:
    needs: [voice-tone-review, terminology-review, clarity-review]
    if: always() && needs.changes.outputs.docs == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Post Summary
        uses: actions/github-script@v7
        with:
          script: |
            const jobs = [
              { name: 'Voice/Tone', status: '${{ needs.voice-tone-review.result }}' },
              { name: 'Terminology', status: '${{ needs.terminology-review.result }}' },
              { name: 'Clarity', status: '${{ needs.clarity-review.result }}' }
            ];

            const statusEmoji = {
              'success': '‚úÖ',
              'failure': '‚ùå',
              'skipped': '‚è≠Ô∏è',
              'cancelled': 'üö´'
            };

            let summary = '## üìù Documentation Review Summary\n\n';
            summary += '| Check | Status |\n|-------|--------|\n';

            for (const job of jobs) {
              const emoji = statusEmoji[job.status] || '‚ùì';
              summary += `| ${job.name} | ${emoji} ${job.status} |\n`;
            }

            summary += '\n---\n';
            summary += '*Review powered by Claude Code SME agents*\n';
            summary += '\n**To apply fixes:** Comment `/fix-docs` on this PR';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: summary
            });

  # Auto-fix workflow (triggered by /fix-docs comment)
  auto-fix:
    if: github.event_name == 'issue_comment' && contains(github.event.comment.body, '/fix-docs')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref }}

      - name: Apply Fixes
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ENG_ANTHROPIC_API_KEY }}
          direct_prompt: |
            Use the docs-fix agent to apply fixes to all changed documentation files in this PR.

            Apply fixes for:
            - Terminology standardization
            - Voice and tone consistency
            - Formatting corrections
            - Inclusive language updates

            Do NOT change code blocks or alter technical meaning.
          allowed_tools: "read,write,grep,glob,diff"

      - name: Commit Fixes
        run: |
          git config user.name "Claude Code Bot"
          git config user.email "claude-bot@seqera.io"
          git add -A
          git diff --staged --quiet || git commit -m "docs: apply automated style fixes"
          git push
